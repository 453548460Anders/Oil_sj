<template>
  <div class="page search-location" data-name="catalog">
    <div class="navbar">
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="javascript:void(0);" class="link back">
            <i class="icon icon-back color-blue"></i>
          </a>
        </div>
        <div class="title">修改密码</div>
        <div class="right" style="width: 66px"></div>
      </div>
    </div>
    <div class="page-content">
      <div class="list inline-labels no-hairlines-md">
        <div id="message" class="me-update-password-promt">
        </div>
        <ul>
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-input-wrap register-tel">
                <input id="register-tel-id" type="tel" placeholder="请输入手机号">
                <span class="input-clear-button"></span>
              </div>
            </div>
            <div class="item-media">
              <button class="col button button-fill send-number-btn">发送验证码</button>
            </div>
          </li>
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-input-wrap">
                <input id="number" type="number" placeholder="验证码">
                <span class="input-clear-button"></span>
              </div>
            </div>
          </li>
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-input-wrap">
                <input id="newpassword" type="password" placeholder="新密码">
                <span class="input-clear-button"></span>
              </div>
            </div>
          </li>
        </ul>
      </div>
      <div class="report-submit">
        <button class="col button button-fill report-submit-btn" id="confirmUpdPasswordBtn">确定</button>
      </div>
    </div>
  </div>
</template>
<script>
  return {
    on: {
      pageMounted: function (e, page) {
        var me = this;

        var code = '';// 验证码

        var number = '';

        me.$app.loginScreen.close('#my-login-screen');

        // 隐藏toolbar
        me.$$('.toolbar').addClass('hidden');

        // 发送验证码
        me.$('.send-number-btn').on('click', function () {
          var telphone = me.$('#register-tel-id')[0].value;
          if (!telphone) {
            var toastTop = app.toast.create({
              text: '请输入手机号码!',
              position: 'center',
              closeTimeout: 2000,
            });
            toastTop.open();
            return;
          }
          if (!(/^1[34578]\d{9}$/.test(telphone))) {
            var toastTop = app.toast.create({
              text: '手机号码不正确!',
              position: 'center',
              closeTimeout: 2000,
            });
            toastTop.open();
            return;
          }
          me.$app.preloader.show();
          me.$app.request.post(window.url + 'type=getyzm',
            {
              moblie: telphone,
            },
            function (data) {
              me.$app.preloader.hide();
              console.error('发送验证码', JSON.parse(data));
              var result = JSON.parse(data);
              if (result.errcode === '00000') {
                code = result.code;
              }
            });
        });

        me.$('#confirmUpdPasswordBtn').on('click', function () {
          var inputNumber = me.$('#number')[0].value;
          if (inputNumber && code && (inputNumber !== code)) {
            var toastTop = app.toast.create({
              text: '验证码不正确!',
              position: 'center',
              closeTimeout: 2000,
            });
            toastTop.open();
            return;
          }
          var newpassword = me.$('#newpassword')[0].value;
          app.request.post(window.url + 'type=findpass', {
            moblie: me.$('#register-tel-id')[0].value,
            newpassword: newpassword
          }, function (data) {
            var result = JSON.parse(data);
            if (result.errcode !== '00000') {
              var toastTop = app.toast.create({
                text: result.result || '系统错误!',
                position: 'center',
                closeTimeout: 2000,
              });
              toastTop.open();
            } else {
              var toastTop = app.toast.create({
                text: '密码修改成功',
                position: 'center',
                closeTimeout: 2000,
              });
              toastTop.open();
              setTimeout(function () {
                me.$router.back();
              }, 2000);
            }
          });
        });

        me.$('.back').on('click', function (event) {
          console.error('返回');
          event.stopPropagation();
          event.preventDefault();
          me.$app.loginScreen.open('#my-login-screen');
          setTimeout(function () {
            me.$router.back();
            if (me.router) {
              me.router.navigate(me.router.currentRoute.url, {
                reloadCurrent: true,
                ignoreCache: true,
              });
            }
          }, 100);
        });
      }
    },
    beforeDestroy: function () {
      this.$$('.toolbar').removeClass('hidden');
    },
  };
</script>