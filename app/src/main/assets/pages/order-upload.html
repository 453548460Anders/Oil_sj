<template>
  <div class="page" data-name="catalog">
    <div class="navbar">
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="link back">
            <i class="icon icon-back color-blue"></i>
          </a>
        </div>
        <div class="title">上传磅单</div>
        <div class="right" style="width: 66px"></div>
        <div class="subnavbar upload-order-tabs">
          <div class="subnavbar-inner">
            <div class="segmented segmented-raised">
              <a id="tab1-id" class="button tab-link tab-link-active order-tab" href="#tab1">
                <span class="tab-text">装车磅单</span>
              </a>
              <a id="tab2-id" class="button tab-link order-tab" href="#tab2">
                <span class="tab-text">卸车磅单</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="page-content hide-navbar-on-scroll">
      <div class="tabs">
        <div class="tab tab-active" id="tab1">
          <div class="list inline-labels no-hairlines-md">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">装货日期</div>
                  <div class="item-input-wrap">
                    <input id="tab1-date-id" type="text" placeholder="请选择日期" onfocus="(this.type='date')" onblur="(this.type='text')">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">装货吨数</div>
                  <div class="item-input-wrap">
                    <input id="tab1-count-id" type="number" placeholder="请输入">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
              <li class="item-content item-input order-upload-container">
                <div class="item-inner ">
                  <div class="item-title item-label">装货图片</div>
                  <div>
                    <button id="order-zhuanghuo-btn-id" class="col button button-fill order-upload-btn" data-set="tab1">上传</button>
                  </div>
                </div>
                <div class="order-upload-image" id="order-upload-image-tab1">
                  <img src="./images/default_order.png" style="width: 100%;" />
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div class="tab" id="tab2">
          <div class="list inline-labels no-hairlines-md">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">卸货日期</div>
                  <div class="item-input-wrap">
                    <input placeholder="请选择日期" onfocus="(this.type='date')" onblur="(this.type='text')" id="tab2-date-id" type="text" placeholder="请输入">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">卸货吨数</div>
                  <div class="item-input-wrap">
                    <input id="tab2-count-id" type="number" placeholder="请输入">
                    <span class="input-clear-button"></span>
                  </div>
                </div>
              </li>
              <li class="item-content item-input order-upload-container">
                <div class="item-inner ">
                  <div class="item-title item-label">卸货图片</div>
                  <div>
                    <button id="order-xiehuo-btn-id" class="col button button-fill order-upload-btn" data-set="tab2">上传</button>
                  </div>
                </div>
                <div class="order-upload-image" id="order-upload-image-tab2">
                  <img src="./images/default_order.png" style="width: 100%;" />
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="order-upload-btn-container">
        <button id="order-upload-submit-id" class="col button button-fill">提交</button>
      </div>
    </div>
  </div>
</template>
<script>
  return {
    on: {
      pageMounted: function (e, page) {
        var me = this;
        console.error('上传磅单', this);
        mui.back = function () {
          me.$router.back();
          setTimeout(function () {
            $$(document).trigger('hallReady');
            $$(document).trigger('orderReady');
          }, 500);
        }
        me.$('.back').on('click', function (event) {
          event.stopPropagation();
          event.preventDefault();
          $$(document).trigger('orderReady');
          me.$router.navigate('/order/');
        });
        me.$$('.toolbar').addClass('hidden');
        var imgData1 = '', imgData2 = '', tab = 'tab1';
        me.$('#tab1-id').on('click', function () {
          tab = 'tab1';
          submitBtnFn();
        });
        me.$('#tab2-id').on('click', function () {
          tab = 'tab2';
          submitBtnFn();
        });

        // 判断是否显示提交
        var submitBtnFn = function () {
          var state = me.state;
          if (tab === 'tab1') {
            if (Number(state) >= 3) {
              me.$('.order-upload-btn-container').css('display', 'none');
              me.$('#tab1-date-id').attr("readonly", "readonly");
              me.$('#tab1-count-id').attr("readonly", "readonly");
              me.$('#order-zhuanghuo-btn-id').css("display", "none");
            } else {
              me.$('.order-upload-btn-container').css('display', 'flex');
              me.$('#tab1-date-id').removeAttr("readonly");
              me.$('#tab1-count-id').removeAttr("readonly");
              me.$('#order-zhuanghuo-btn-id').css("display", "block");
            }
          } else {
            if (Number(state) > 3) {
              me.$('.order-upload-btn-container').css('display', 'none');
              me.$('#tab2-date-id').attr("readonly", "readonly");
              me.$('#tab2-count-id').attr("readonly", "readonly");
              me.$('#order-xiehuo-btn-id').css("display", "none");
            } else {
              me.$('.order-upload-btn-container').css('display', 'flex');
              me.$('.order-upload-btn-container').css('display', 'flex');
              me.$('#tab1-date-id').removeAttr("readonly");
              me.$('#tab1-count-id').removeAttr("readonly");
              me.$('#order-xiehuo-btn-id').css("display", "block");
            }
          }
        }
        submitBtnFn();

        //拍照 
        var getBase64Image = function (img) {
          var canvas = document.createElement("canvas");
          var width = plus.display.resolutionWidth;
          var height = plus.display.resolutionHeight;
          canvas.width = width; /*设置新的图片的宽度*/
          canvas.height = height; /*设置新的图片的长度*/
          var ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height); /*绘图*/
          return canvas.toDataURL("image/png", 0.8);
        }
        me.$$('.order-upload-btn').on('click', function (event) {
          tab = event.target.dataset.set;
          var cmr = plus.camera.getCamera();
          var res = cmr.supportedImageResolutions[0];
          var fmt = cmr.supportedImageFormats[0];
          cmr.captureImage(function (path) {
            plus.io.resolveLocalFileSystemURL(path, function (entry) {
              var localUrl = entry.toLocalURL();
              var image = new Image();
              image.src = localUrl;
              image.onload = function () {
                imgData = getBase64Image(image);
                var imageHtml = '<img id="idCard" src="' + imgData + '"/>';
                if (tab === 'tab1') {
                  imgData1 = imgData;
                  me.$('#order-upload-image-tab1').html(imageHtml);
                  if (me.$('.order-img-container').length > 0) {
                    me.$('.order-img-container').html(imageHtml);
                  }
                } else {
                  imgData2 = imgData;
                  me.$('#order-upload-image-tab2').html(imageHtml);
                  if (me.$('.order-img-container').length > 0) {
                    me.$('.order-img-container').html(imageHtml);
                  }
                }
              }
            }, function (err) {
            }, {
                index: 1
              });
          });
        });

        me.$('#order-upload-submit-id').on('click', function () {
          // 提交
          if (tab === 'tab1') {
            var date = me.$('#tab1-date-id')[0].value;
            var count = me.$('#tab1-count-id')[0].value;
            if (!date) {
              var toastTop = app.toast.create({
                text: '请选择装货日期!',
                position: 'center',
                closeTimeout: 2000,
              });
              toastTop.open();
              return;
            }
            if (!count) {
              var toastTop = app.toast.create({
                text: '请输入装货吨数!',
                position: 'center',
                closeTimeout: 2000,
              });
              toastTop.open();
              return;
            }
            me.$app.preloader.show();
            app.request.post(window.url + 'type=addzcbd', {
              id: me.carid || me.id,
              zhrq: date,
              zhds: count,
              zhtp: imgData1
            },
              function (data) {
                me.$app.preloader.hide();
                console.error('上传装货磅单', JSON.parse(data));
                var result = JSON.parse(data);
                if (result.errcode !== '00000') {
                  var toastTop = app.toast.create({
                    text: result.result || '系统错误!',
                    position: 'center',
                    closeTimeout: 2000,
                  });
                  toastTop.open();
                } else {
                  var toastTop = app.toast.create({
                    text: '上传成功!',
                    position: 'center',
                    closeTimeout: 2000,
                  });
                  toastTop.open();
                  $$(document).trigger('orderReady');
                  $$(document).trigger('refreshOrderDetail');
                  setTimeout(function () {
                    me.$router.back();
                  }, 2000);
                }
              });
          } else {
            var date = me.$('#tab2-date-id')[0].value;
            var count = me.$('#tab2-count-id')[0].value;
            if (!date) {
              var toastTop = app.toast.create({
                text: '请选择卸货日期!',
                position: 'center',
                closeTimeout: 2000,
              });
              toastTop.open();
              return;
            }
            if (!count) {
              var toastTop = app.toast.create({
                text: '请输入卸货吨数!',
                position: 'center',
                closeTimeout: 2000,
              });
              toastTop.open();
              return;
            }
            me.$app.preloader.show();
            app.request.post(window.url + 'type=addxcbd', {
              id: me.carid || me.id,
              xhrq: date,
              xhds: count,
              xhtp: imgData2
            },
              function (data) {
                me.$app.preloader.hide();
                console.error('上传卸货磅单', JSON.parse(data));
                var result = JSON.parse(data);
                if (result.errcode !== '00000') {
                  var toastTop = app.toast.create({
                    text: result.result || '系统错误!',
                    position: 'center',
                    closeTimeout: 2000,
                  });
                  toastTop.open();
                } else {
                  var toastTop = app.toast.create({
                    text: '上传成功!',
                    position: 'center',
                    closeTimeout: 2000,
                  });
                  toastTop.open();
                  $$(document).trigger('orderReady');
                  $$(document).trigger('refreshOrderDetail');
                  setTimeout(function () {
                    me.$router.back();
                  }, 2000);
                }
              });
          }
        });

        // 获取已上传的磅单
        app.request.post(window.url + 'type=getbdnmodel', {
          id: me.carid || me.id,
          type: me.type
        },
          function (data) {
            console.error('已上传磅单2', data);
            var result = JSON.parse(data);
            me.$('#tab1-date-id')[0].value = result.zhrq;
            me.$('#tab1-count-id')[0].value = result.zhds;
            result.zhtp ? me.$('#order-upload-image-tab1').html('<img id="idCard" src="' + window.imageUrl + result.zhtp + '"/>') : '';

            me.$('#tab2-date-id')[0].value = result.xhrq;
            me.$('#tab2-count-id')[0].value = result.xhds;
            result.xhtp ? me.$('#order-upload-image-tab2').html('<img id="idCard" src="' + window.imageUrl + result.xhtp + '"/>') : '';
          });
        me.$$('.toolbar').addClass('hidden');
      }
    },
    beforeDestroy: function () {
      this.$$('.toolbar').removeClass('hidden');
    },
  };
</script>