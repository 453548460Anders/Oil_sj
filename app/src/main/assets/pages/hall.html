<template>
  <div class="page hall" data-name="catalog">
    <div class="navbar">
      <div class="navbar-inner sliding">
        <div class="title">当前订单</div>
      </div>
    </div>
    <div id="wrapper" class="page-content">
      <div id="scroller"></div>
    </div>
  </div>
  </div>
</template>
<script>return {
    on: {
      pageMounted: function (e, page) {
        var total = 0;
        var me = this;
        window.plus && window.plus.screen.lockOrientation("portrait-primary");

        me.$(document).on('hallReady', function () {
          mui.back = function () {
            if (!first) {
              first = new Date().getTime();
              mui.toast('再按一次退出应用');

              setTimeout(function () {
                first = null;
              }, 1000);
            }

            else {
              if (new Date().getTime() - first < 1000) {
                plus.runtime.quit();
              }
            }
          }

          console.error('-----------大厅页面 hallReady---------------', window);
          me.$$('.toolbar').removeClass('hidden');

          const searchHall = function (searchKey, noDataText) {
            me.$app.preloader.show();

            me.$app.request.post(window.url + 'type=getdriverorder', {
              searchtype: 0,
              userid: window.userid,
              start: 0,
              count: 10,
            } , function (data) {
                console.error('sasssssss' + data);
                const htmlText = '<ul>{{#each list}}<li class="hall-item-li swipeout">' 
                + ' <div class="hall-container swipeout-content"><div class="hall-item"><div class="hall-item-address">{{zhd}}<=>{{xhd}}</div>' 
                + ' <div class="hall-item-detail">{{proname}}/{{weight}}/¥{{price}}</div>' 
                + '  <div class="hall-item-date">{{starttime}}-{{endtime}}</div> </div>' 
                + '<div class="hall-item-address">{{BusinessInfo}}</div>'
                + '<div class="hall-operate"> <div class="operate">' 
                + ' </div> </div></div>  ' 
                + '<div class="swipeout-actions-right"  data-set={{@index}}>' 
                + '<a data-set={{@index}} href="#" class="swipeout-upload1" style="height: 100px;background: #98999A;">磅单上传</a>' 
                + '<a data-set={{@index}} href="#" class="swipeout-upload2" style="height: 100px;background: #558FF2;">铅封上传</a>' 
                + '</div>' + '</li> {{/each}}</ul>';
                // compile it with Template7
                var compiledTemplate = Template7.compile(htmlText);
                const result = JSON.parse(data);
                console.error('当前订单', result);
                total = result.total;

                if (result && result.data && result.data.length > 0) {
                  var html = compiledTemplate({
                    list: result.data
                  }

                  );
                  me.$('#scroller').html(html);

                  // 无限刷新
                  loaded();
                  // 磅单上传
                  me.$('.swipeout-upload1').on('click', function (event) {
                    const index = event.target.dataset.set;
                    console.error('磅单上传', index);
                    me.$app.router.navigate('/order-upload1/', {
                      context: result.data[index]
                    });
                  });

                  // 铅封上传
                  me.$('.swipeout-upload2').on('click', function (event) {
                    const index = event.target.dataset.set;
                    console.error('铅封上传', index);

                    me.$app.router.navigate('/order-upload2/', {
                      context: result.data[index]
                    });
                  });

                  me.$('.hall-item-li').on('click', function () {
                    var el = me.$(this);
                    if (el.hasClass('swipeout-opened')) {
                      app.swipeout.close(el)
                    }
                    else {
                      app.swipeout.open(el);
                    }
                  });
               } else {
                  const text = noDataText || '没有订单数据';
                  me.$('#scroller').empty();
                  me.$('#scroller').html('<span class="no-data">' + text + '</span>');
                }
                me.$app.preloader.hide();
              }

            );
          }

          searchHall();

          // 无限刷新
          var myScroll;

          function loaded() {
            myScroll = new IScroll('#wrapper', {
              mouseWheel: true,
              infiniteElements: '#scroller .hall-item-li',
              infiniteLimit: total,
              dataset: requestData,
              dataFiller: updateContent,
              cacheSize: 10000
            });
          }

          function requestData(start, count) {
            console.error('requestData111', start, count);
            me.$app.preloader.show();

            me.$app.request.post(window.url + 'type=getdriverorder', {
              searchtype: 0,
              userid: window.userid,
              start: start,
              count: count,
            },
              function (data) {
                me.$app.preloader.hide();
                myScroll.updateCache(start, JSON.parse(data).data);
              }

            );
          }

          function updateContent(el, data) {
          	console.error('updateContent', data);
            if (!data) {
              return;
            }

            const htmlText = '<div class="hall-container swipeout-content"><div class="hall-item"><div class="hall-item-address">{{zhd}}<=>{{xhd}}</div>' 
            + ' <div class="hall-item-detail">{{proname}}/{{weight}}/¥{{price}}</div>' 
            + '  <div class="hall-item-date">{{starttime}}-{{endtime}}</div> </div>'
            + '<div class="hall-item-address">{{BusinessInfo}}</div>'
            + '<div class="hall-operate"> <div class="operate">' 
            + ' </div> </div></div>  ' 
            + '<div class="swipeout-actions-right"  data-set={{@index}}>' + '<a data-set={{@index}} href="#" class="swipeout-upload1" style="height: 100px;background: #98999A;">磅单上传</a>' + '<a data-set={{@index}} href="#" class="swipeout-upload2" style="height: 100px;background: #558FF2;">铅封上传</a>' + '</div>';
            var compiledTemplate = Template7.compile(htmlText);
            var html = compiledTemplate(data);
            el.innerHTML = html;

            me.$('.swipeout-upload1').on('click', function () {
              me.$app.router.navigate('/order-upload1/', {
                context: data
              });
            });

            // 铅封上传
            me.$('.swipeout-upload2').on('click', function () {
              me.$app.router.navigate('/order-upload2/', {
                context: data
              });
            });
          }

          setTimeout(function () {
            /**
               * 获取版本号 
               */
            var getVersionNumber = function () {
              try {
                me.$app.request.post(window.url + 'type=GetVersion', {
                  searchtype: 2
                }

                  ,
                  function (data) {
                    console.error('版本号', data);
                    const resultObj = JSON.parse(data);

                    if ((/android/gi).test(navigator.appVersion)) {
                      window.plus && plus.runtime.getProperty(plus.runtime.appid, function (inf) {
                        var version = Number(inf.version.substr(1));

                        if (Number(resultObj.version.substr(1)) > version) {
                          plus.nativeUI.confirm("发现新版本，是否立即更新？", function (e) {
                            if (e.index == 0) {
                              plus.nativeUI.showWaiting("下载新版应用程序...");

                              plus.downloader.createDownload(window.imageUrl + resultObj.path, {}

                                , function (d, status) {
                                  if (status == 200) {
                                    plus.nativeUI.showWaiting("正在安装...");

                                    plus.runtime.install(d.filename, {}

                                      , function () {
                                        plus.nativeUI.closeWaiting();

                                        plus.nativeUI.alert("应用更新完成！", function () {
                                          plus.runtime.restart();
                                        }

                                        );
                                      }

                                      , function (e) {
                                        plus.nativeUI.closeWaiting();
                                        plus.nativeUI.alert("安装失败[" + e.code + "]：" + e.message);
                                      }

                                    );
                                  }

                                  else {
                                    plus.nativeUI.alert("下载新版应用程序失败！");
                                  }

                                  plus.nativeUI.closeWaiting();
                                }

                              ).start();
                            }
                          }

                          );
                        }

                        ;
                      }

                      );
                    }
                  }

                  ,
                  function (xhr, type) {
                    var toastTop = app.toast.create({
                      text: '获取版本号码失败!',
                      position: 'center',
                      closeTimeout: 2000,
                    }

                    );
                    toastTop.open();
                  }

                );
              }

              catch (e) {
                var toastTop = app.toast.create({
                  text: '获取版本号码失败!',
                  position: 'center',
                  closeTimeout: 2000,
                }

                );
                toastTop.open();
              }
            }

            getVersionNumber();
          }, 5000);
        }
        );
      }
    }
  }

</script>